name: C++ CI/CD for Physics Simulator

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  # Job для подготовки версии (только для push в main/master)
  prepare-version:
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    runs-on: ubuntu-latest
    outputs:
      new_tag: ${{ steps.bump_version.outputs.new_tag }}
      release_name: ${{ steps.generate_name.outputs.release_name }}
    
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Get latest tag
        id: get_tag
        run: |
          git fetch --tags --force
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
          echo "last_tag=$LAST_TAG" >> $GITHUB_OUTPUT
          echo "LAST_TAG=$LAST_TAG" >> $GITHUB_ENV
          
      - name: Bump patch version
        id: bump_version
        run: |
          # Убираем 'v' из тега
          VERSION=${LAST_TAG#v}
          IFS='.' read -r MAJOR MINOR PATCH <<< "$VERSION"
          
          # Увеличиваем патч
          NEW_PATCH=$((PATCH + 1))
          NEW_TAG="v${MAJOR}.${MINOR}.${NEW_PATCH}"
          
          echo "new_tag=$NEW_TAG" >> $GITHUB_OUTPUT
          echo "NEW_TAG=$NEW_TAG" >> $GITHUB_ENV
          
      - name: Generate release name
        id: generate_name
        run: |
          SHORT_SHA=${GITHUB_SHA::7}
          DATE=$(date +'%Y.%m.%d')
          RELEASE_NAME="Release ${NEW_TAG} (${DATE} - ${SHORT_SHA})"
          echo "release_name=$RELEASE_NAME" >> $GITHUB_OUTPUT

  # Параллельные сборки (запускаются всегда)
  build-linux:
    runs-on: ubuntu-latest
    needs: [prepare-version]
    
    steps:
      - uses: actions/checkout@v4
        
      - name: Build with version
        run: |
          VERSION="${{ needs.prepare-version.outputs.new_tag || 'dev-build' }}"
          echo "Building version: $VERSION"
          cmake -B build -G Ninja -DVERSION="$VERSION"
          cmake --build build
          
      - name: Create Linux package
        run: |
          VERSION="${{ needs.prepare-version.outputs.new_tag || 'dev' }}"
          mkdir -p physics-linux-${VERSION#v}
          cp build/physics physics-linux-${VERSION#v}/
          tar -czf physics-linux-${VERSION#v}.tar.gz physics-linux-${VERSION#v}/
          
      - name: Upload Linux artifact
        uses: actions/upload-artifact@v4
        with:
          name: physics-linux
          path: physics-linux-*.tar.gz

  build-windows:
    runs-on: windows-latest
    needs: [prepare-version]
    
    steps:
      - uses: actions/checkout@v4
        
      - name: Build with version
        run: |
          $VERSION = "${{ needs.prepare-version.outputs.new_tag || 'dev-build' }}"
          echo "Building version: $VERSION"
          cmake -B build -G Ninja -DVERSION="$VERSION"
          cmake --build build
          
      - name: Create Windows package
        run: |
          $VERSION = "${{ needs.prepare-version.outputs.new_tag || 'dev' }}"
          $FOLDER = "physics-windows-${VERSION#v}"
          mkdir $FOLDER
          Copy-Item build/physics.exe $FOLDER/
          Compress-Archive -Path $FOLDER/* -DestinationPath physics-windows-${VERSION#v}.zip
          
      - name: Upload Windows artifact
        uses: actions/upload-artifact@v4
        with:
          name: physics-windows
          path: physics-windows-*.zip

  # Создание релиза только после успешных сборок
  create-release:
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    needs: [prepare-version, build-linux, build-windows]
    runs-on: ubuntu-latest
    permissions:
      contents: write
      
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.prepare-version.outputs.new_tag }}
          name: ${{ needs.prepare-version.outputs.release_name }}
          body: |
            # Physics Simulator ${{ needs.prepare-version.outputs.new_tag }}
            
            **Build Details:**
            - Commit: [${{ github.sha }}](https://github.com/${{ github.repository }}/commit/${{ github.sha }})
            - Date: ${{ github.event.head_commit.timestamp }}
            
            **Artifacts:**
            - `physics-linux-*.tar.gz` - Linux executable
            - `physics-windows-*.zip` - Windows executable
            
            **Changelog:**
            ${{ github.event.head_commit.message }}
          draft: false
          prerelease: false
          files: |
            physics-linux-*.tar.gz
            physics-windows-*.zip