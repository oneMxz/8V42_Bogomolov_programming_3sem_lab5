name: C++ CI/CD for Physics Simulator

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  build-linux:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install SFML dependencies (Ubuntu)
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libxrandr-dev \
            libxcursor-dev \
            libudev-dev \
            libopenal-dev \
            libflac-dev \
            libvorbis-dev \
            libgl1-mesa-dev \
            libfreetype6-dev \
            ninja-build \
            cmake \
            xvfb

      - name: Configure CMake with Ninja
        run: |
          cmake -B build -G Ninja -DCMAKE_BUILD_TYPE=Release

      - name: Build project
        run: |
          cmake --build build --config Release

      - name: Test executable exists
        run: |
          if [ -f "build/physics" ]; then
            echo "‚úÖ Executable built successfully"
            ls -lh build/physics
          else
            echo "‚ùå Executable not found!"
            find build/ -type f -name "*" | head -20
            exit 1
          fi

      - name: Check data files
        run: |
          if [ -d "data" ]; then
            echo "Data directory exists"
            ls -la data/
            echo "First few lines of smile.txt:"
            head -5 data/smile.txt
            echo "First few lines of elephant.txt:"
            head -5 data/elephant.txt
          else
            echo "‚ùå Data directory not found!"
            exit 1
          fi

      - name: Run headless test with xvfb
        run: |
          echo "Testing physics simulator with smile.txt..."
          # –ó–∞–ø—É—Å–∫–∞–µ–º –Ω–∞ 2 —Å–µ–∫—É–Ω–¥—ã –∏ –∑–∞–≤–µ—Ä—à–∞–µ–º
          timeout 2 xvfb-run -a ./build/physics data/smile.txt &
          sleep 1
          echo "Test completed"

  build-windows:
    runs-on: windows-latest
    
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install CMake and Ninja
        uses: seanmiddleditch/gha-setup-ninja@master

      - name: Configure CMake with Ninja
        run: |
          cmake -B build -G Ninja -DCMAKE_BUILD_TYPE=Release

      - name: Build project
        run: |
          cmake --build build --config Release

      - name: Test executable exists
        run: |
          if (Test-Path "build\Release\physics.exe") {
            echo "‚úÖ Executable built successfully (Release)"
            Get-Item "build\Release\physics.exe"
            $exePath = "build\Release\physics.exe"
          } elseif (Test-Path "build\physics.exe") {
            echo "‚úÖ Executable built successfully (alternative)"
            Get-Item "build\physics.exe"
            $exePath = "build\physics.exe"
          } else {
            echo "‚ùå Executable not found!"
            Get-ChildItem -Path build -Recurse -Include *.exe
            exit 1
          }
          
          # –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—É—Ç—å –¥–ª—è —Å–ª–µ–¥—É—é—â–∏—Ö —à–∞–≥–æ–≤
          echo "EXE_PATH=$exePath" | Out-File -FilePath $env:GITHUB_ENV -Append

      - name: Check data files
        run: |
          if (Test-Path "data") {
            echo "Data directory exists"
            Get-ChildItem -Path data
            echo "First few lines of smile.txt:"
            Get-Content data\smile.txt -Head 5
            echo "First few lines of elephant.txt:"
            Get-Content data\elephant.txt -Head 5
          } else {
            echo "‚ùå Data directory not found!"
            exit 1
          fi

      - name: Run test (non-interactive)
        run: |
          echo "Testing physics simulator (will run for 2 seconds)..."
          # –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–æ—Ü–µ—Å—Å
          $process = Start-Process -FilePath "$env:EXE_PATH" -ArgumentList "data\smile.txt" -NoNewWindow -PassThru
          # –ñ–¥–µ–º 1 —Å–µ–∫—É–Ω–¥—É –∏ –∑–∞–≤–µ—Ä—à–∞–µ–º –ø—Ä–æ—Ü–µ—Å—Å
          Start-Sleep -Seconds 1
          Stop-Process -Id $process.Id -Force
          echo "Test completed"

      - name: Create Windows package (ZIP)
        if: success()
        run: |
          # –°–æ–∑–¥–∞–µ–º –ø–∞–ø–∫—É —Å —Ä–µ–ª–∏–∑–æ–º
          $releaseDir = "physics-windows-$env:GITHUB_RUN_NUMBER"
          New-Item -ItemType Directory -Path $releaseDir -Force
          
          # –ö–æ–ø–∏—Ä—É–µ–º –∏—Å–ø–æ–ª–Ω—è–µ–º—ã–π —Ñ–∞–π–ª
          Copy-Item "$env:EXE_PATH" -Destination "$releaseDir\physics.exe"
          
          # –ö–æ–ø–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ
          if (Test-Path "data") {
            Copy-Item -Recurse "data" -Destination $releaseDir
          }
          
          # –ö–æ–ø–∏—Ä—É–µ–º README –µ—Å–ª–∏ –µ—Å—Ç—å
          if (Test-Path "README.md") {
            Copy-Item "README.md" -Destination $releaseDir
          }
          
          # –°–æ–∑–¥–∞–µ–º ZIP –∞—Ä—Ö–∏–≤
          Compress-Archive -Path "$releaseDir\*" -DestinationPath "physics-windows.zip"

      - name: Upload Windows artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: physics-windows
          path: physics-windows.zip
          retention-days: 7

  create-release:
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    needs: [build-linux, build-windows]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Download Windows artifact
        uses: actions/download-artifact@v4
        with:
          name: physics-windows
          
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ci-build-${{ github.run_number }}
          name: CI Build ${{ github.run_number }}
          body: |
            Automated build of Physics Simulator
            
            **Build Information:**
            - Commit: [${{ github.sha }}](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }})
            - Branch: ${{ github.ref_name }}
            - Workflow: [${{ github.workflow }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            
            **Build Status:**
            - ‚úÖ Linux: Success
            - ‚úÖ Windows: Success
            - üìÖ Build date: ${{ github.event.head_commit.timestamp }}
            
            **Download:**
            - [physics-windows.zip](physics-windows.zip) (Windows executable + data)
            
            This is an automated build from CI/CD pipeline.
          draft: false
          prerelease: false
          files: |
            physics-windows.zip